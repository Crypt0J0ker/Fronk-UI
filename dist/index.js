"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.AcademyForceClient = void 0;
const ethers_1 = require("ethers");
const constants_1 = require("./constants");
const types_1 = require("./contracts/types");
const index_1 = require("./contracts/types/index");
class AcademyForceClient {
    constructor(_signer, _provider) {
        this._signer = _signer;
        this._provider = _provider;
    }
    static fromUrl(url) {
        const provider = new ethers_1.ethers.JsonRpcProvider(url);
        return new this(null, provider);
    }
    static fromChainId(chainId) {
        const provider = new ethers_1.ethers.JsonRpcProvider(constants_1.RPC_URLS[chainId]);
        return new this(null, provider);
    }
    get signer() {
        if (this._signer) {
            if (this._signer.provider) {
                return this._signer;
            }
            throw new Error("AcademyForce client signer has no provider");
        }
        throw new Error("AcademyForce client has no signer");
    }
    get provider() {
        var _a;
        if (this._provider) {
            return this._provider;
        }
        if ((_a = this._signer) === null || _a === void 0 ? void 0 : _a.provider) {
            return this._signer.provider;
        }
        throw new Error("AcademyForce client has no provider");
    }
    async getChainId() {
        const { chainId } = await this.provider.getNetwork();
        return Number(chainId);
    }
    async getContracts() {
        const chainId = await this.getChainId();
        const registryUV = types_1.Registry__factory.connect(constants_1.REGISTRY_ADDRESSES[chainId], this.provider);
        const _metaCoreAddress = await registryUV.getMetaCore();
        const _mfsAddress = await registryUV.getMFS();
        const _stableCoinAddress = await registryUV.getStableCoin();
        const _hMFSAddresses = new Array(constants_1.HMFS_COUNT);

        for (let i = 1; i < constants_1.HMFS_COUNT + 1; i++) {
            _hMFSAddresses[i - 1] = await registryUV.getHMFS(i);
        }
        const _metaCore = types_1.MetaCore__factory.connect(_metaCoreAddress, this.signer);
        const _metaPaymentAddress = await _metaCore.getPaymentChannelAddress();
        return {
            registry: types_1.Registry__factory.connect(constants_1.REGISTRY_ADDRESSES[chainId], this.signer),
            metaCore: _metaCore,
            metaPayment: index_1.MetaPayment__factory.connect(_metaPaymentAddress, this.signer),
            mfs: index_1.Erc20__factory.connect(_mfsAddress, this.signer),
            stablecoin: index_1.Erc20__factory.connect(_stableCoinAddress, this.signer),
        };
    }
    async claim(contract, name) {
        const address = await this.signer.getAddress();
        const academyForceNFT = types_1.AcademyForceNFT__factory.connect(contract, this.signer);
        let res;
        try {
            res = await fetch(process.env.NEXT_PUBLIC_BASE_URL + "/bck/fr/userClaimData", {
                method: "POST",
                body: JSON.stringify({ address, contract, name }),
                headers: { "Content-Type": "application/json" },
            });
        }
        catch (error) {
            return null;
        }
        const data = await res.json();
        const claim = await academyForceNFT.claim(data.address, data.name, data.v, data.r, data.s);
        return claim.wait();
    }
    async getBalancesOnWallet(account) {
        const { mfs, stablecoin } = await this.getContracts();
        const _address = account || (await this.signer.getAddress());
        const _balanceMFS = await mfs.balanceOf(_address);
        const _balanceStable = await stablecoin.balanceOf(_address);
        const _balanceMatic = await this.provider.getBalance(_address);

        return {
            mfs: ethers_1.ethers.utils.formatUnits(_balanceMFS, constants_1.DECIMALS),
            stablecoin: ethers_1.ethers.utils.formatUnits(_balanceStable, constants_1.DECIMALS),
            matic: ethers_1.ethers.utils.formatUnits(_balanceMatic, constants_1.DECIMALS),
        };
    }
    async getBalancesOnPayment(idUser) {
        const { mfs, stablecoin, metaPayment, metaCore } = await this.getContracts();
        const userId = idUser ||
            Number(await metaCore.getUserId(await this.signer.getAddress()));
        const _balanceMFS = await metaPayment.getBalance(mfs.address, userId);
        const _balanceStable = await metaPayment.getBalance(stablecoin.address, userId);
        
        return {
            mfs: ethers_1.ethers.utils.formatUnits(_balanceMFS, constants_1.DECIMALS),
            stablecoin: ethers_1.ethers.utils.formatUnits(_balanceStable, constants_1.DECIMALS),
            matic: "0.0"
        };
    }
}
exports.AcademyForceClient = AcademyForceClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsbUNBQWtEO0FBQ2xELDJDQUFxRztBQUNyRyw2Q0FBbUc7QUFFbkcsbURBR2lDO0FBR2pDLE1BQWEsa0JBQWtCO0lBVzdCLFlBQ21CLE9BQXVCLEVBQ3ZCLFNBQTJCO1FBRDNCLFlBQU8sR0FBUCxPQUFPLENBQWdCO1FBQ3ZCLGNBQVMsR0FBVCxTQUFTLENBQWtCO0lBRzlDLENBQUM7SUFmTSxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQVc7UUFDL0IsTUFBTSxRQUFRLEdBQUcsSUFBSSxlQUFNLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2pELE9BQU8sSUFBSSxJQUFJLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQ2xDLENBQUM7SUFFTSxNQUFNLENBQUMsV0FBVyxDQUFDLE9BQWdCO1FBQ3hDLE1BQU0sUUFBUSxHQUFHLElBQUksZUFBTSxDQUFDLGVBQWUsQ0FBQyxvQkFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFDL0QsT0FBTyxJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQVNELElBQVcsTUFBTTtRQUNmLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNoQixJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFO2dCQUN6QixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUM7YUFDckI7WUFDRCxNQUFNLElBQUksS0FBSyxDQUFDLDRDQUE0QyxDQUFDLENBQUM7U0FDL0Q7UUFFRCxNQUFNLElBQUksS0FBSyxDQUFDLG1DQUFtQyxDQUFDLENBQUM7SUFDdkQsQ0FBQztJQUVELElBQVcsUUFBUTs7UUFDakIsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ2xCLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQztTQUN2QjtRQUNELElBQUksTUFBQSxJQUFJLENBQUMsT0FBTywwQ0FBRSxRQUFRLEVBQUU7WUFDMUIsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQztTQUM5QjtRQUVELE1BQU0sSUFBSSxLQUFLLENBQUMscUNBQXFDLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBRVMsS0FBSyxDQUFDLFVBQVU7UUFDeEIsTUFBTSxFQUFFLE9BQU8sRUFBRSxHQUFHLE1BQU0sSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUNyRCxPQUFPLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUN6QixDQUFDO0lBRVMsS0FBSyxDQUFDLFlBQVk7UUFDMUIsTUFBTSxPQUFPLEdBQUcsTUFBTSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDeEMsTUFBTSxVQUFVLEdBQUcseUJBQWlCLENBQUMsT0FBTyxDQUMxQyw4QkFBa0IsQ0FBQyxPQUFPLENBQUMsRUFDM0IsSUFBSSxDQUFDLFFBQVEsQ0FDZCxDQUFDO1FBQ0YsTUFBTSxnQkFBZ0IsR0FBRyxNQUFNLFVBQVUsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUN4RCxNQUFNLFdBQVcsR0FBRyxNQUFNLFVBQVUsQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUM5QyxNQUFNLGtCQUFrQixHQUFHLE1BQU0sVUFBVSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQzVELE1BQU0sY0FBYyxHQUFHLElBQUksS0FBSyxDQUFDLHNCQUFVLENBQUMsQ0FBQztRQUM3QyxLQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUMsc0JBQVUsR0FBQyxDQUFDLEVBQUMsQ0FBQyxFQUFFLEVBQUM7WUFDaEMsY0FBYyxDQUFDLENBQUMsR0FBQyxDQUFDLENBQUMsR0FBRyxNQUFNLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDbkQ7UUFDRCxNQUFNLFNBQVMsR0FBRyx5QkFBaUIsQ0FBQyxPQUFPLENBQ3pDLGdCQUFnQixFQUNoQixJQUFJLENBQUMsTUFBTSxDQUNaLENBQUM7UUFDRixNQUFNLG1CQUFtQixHQUFHLE1BQU0sU0FBUyxDQUFDLHdCQUF3QixFQUFFLENBQUM7UUFDdkUsT0FBTztZQUNMLFFBQVEsRUFBRSx5QkFBaUIsQ0FBQyxPQUFPLENBQUMsOEJBQWtCLENBQUMsT0FBTyxDQUFDLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQztZQUM3RSxRQUFRLEVBQUUsU0FBUztZQUNuQixXQUFXLEVBQUUsNEJBQW9CLENBQUMsT0FBTyxDQUN2QyxtQkFBbUIsRUFDbkIsSUFBSSxDQUFDLE1BQU0sQ0FDWjtZQUNELEdBQUcsRUFBRSxzQkFBYyxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQztZQUNyRCxVQUFVLEVBQUUsc0JBQWMsQ0FBQyxPQUFPLENBQUMsa0JBQWtCLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQztTQUNwRSxDQUFDO0lBQ0osQ0FBQztJQUVNLEtBQUssQ0FBQyxLQUFLLENBQ2pCLFFBQWUsRUFDZixJQUFZO1FBRVgsTUFBTSxPQUFPLEdBQUcsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQy9DLE1BQU0sZUFBZSxHQUFHLGdDQUF3QixDQUFDLE9BQU8sQ0FDdEQsUUFBUSxFQUNSLElBQUksQ0FBQyxNQUFNLENBQ1YsQ0FBQztRQUNKLElBQUksR0FBRyxDQUFDO1FBQ1IsSUFBSTtZQUNGLEdBQUcsR0FBRyxNQUFNLEtBQUssQ0FBQyxzQkFBVSxFQUFFO2dCQUM1QixNQUFNLEVBQUUsTUFBTTtnQkFDZCxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLENBQUM7Z0JBQ2pELE9BQU8sRUFBRSxFQUFFLGNBQWMsRUFBRSxrQkFBa0IsRUFBRTthQUNoRCxDQUFDLENBQUM7U0FDSjtRQUFDLE9BQU8sS0FBSyxFQUFFO1lBQ2QsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUNELE1BQU0sSUFBSSxHQUFHLE1BQU0sR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzlCLE1BQU0sS0FBSyxHQUFHLE1BQU0sZUFBZSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLEVBQUUsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2hHLE9BQU8sS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ3RCLENBQUM7SUFFTSxLQUFLLENBQUMsbUJBQW1CLENBQUMsT0FBZ0I7UUFDL0MsTUFBTSxFQUFFLEdBQUcsRUFBRSxVQUFVLEVBQUMsR0FBRyxNQUFNLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNyRCxNQUFNLFFBQVEsR0FBRyxPQUFPLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQztRQUU3RCxNQUFNLFdBQVcsR0FBSSxNQUFNLEdBQUcsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDbkQsTUFBTSxjQUFjLEdBQUksTUFBTSxVQUFVLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzdELE1BQU0sYUFBYSxHQUFHLE1BQU0sSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDL0QsT0FBTztZQUNMLEdBQUcsRUFBRSxlQUFNLENBQUMsV0FBVyxDQUFDLFdBQVcsRUFBRSxvQkFBUSxDQUFDO1lBQzlDLFVBQVUsRUFBRSxlQUFNLENBQUMsV0FBVyxDQUFDLGNBQWMsRUFBRSxvQkFBUSxDQUFDO1lBQ3hELEtBQUssRUFBRSxlQUFNLENBQUMsV0FBVyxDQUFDLGFBQWEsRUFBRSxvQkFBUSxDQUFDO1NBQ25ELENBQUM7SUFDSixDQUFDO0lBRU0sS0FBSyxDQUFDLG9CQUFvQixDQUFDLE1BQWU7UUFDL0MsTUFBTSxFQUFFLEdBQUcsRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxHQUM5QyxNQUFNLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUM1QixNQUFNLE1BQU0sR0FDVixNQUFNO1lBQ04sTUFBTSxDQUNKLE1BQU0sUUFBUSxDQUFDLFNBQVMsQ0FBQyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FDekQsQ0FBQztRQUNKLE1BQU0sV0FBVyxHQUFJLE1BQU0sV0FBVyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDNUUsTUFBTSxjQUFjLEdBQUksTUFBTSxXQUFXLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxVQUFVLEVBQUUsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUV0RixPQUFPO1lBQ0wsR0FBRyxFQUFFLGVBQU0sQ0FBQyxXQUFXLENBQUMsV0FBVyxFQUFFLG9CQUFRLENBQUM7WUFDOUMsVUFBVSxFQUFFLGVBQU0sQ0FBQyxXQUFXLENBQUMsY0FBYyxFQUFFLG9CQUFRLENBQUM7WUFDeEQsS0FBSyxFQUFFLEtBQUs7U0FDYixDQUFDO0lBQ0osQ0FBQztDQUNGO0FBbElELGdEQWtJQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFByb3ZpZGVyLCBTaWduZXIsIGV0aGVycyB9IGZyb20gXCJldGhlcnNcIjtcclxuaW1wb3J0IHsgQ2hhaW5JZCwgREVDSU1BTFMsIEhNRlNfQ09VTlQsIFJFR0lTVFJZX0FERFJFU1NFUywgUlBDX1VSTFMsIFNFUlZFUl9VUkx9IGZyb20gXCIuL2NvbnN0YW50c1wiO1xyXG5pbXBvcnQgeyBBY2FkZW15Rm9yY2VORlRfX2ZhY3RvcnksIE1ldGFDb3JlX19mYWN0b3J5LCBSZWdpc3RyeV9fZmFjdG9yeSB9IGZyb20gXCIuL2NvbnRyYWN0cy90eXBlc1wiO1xyXG5pbXBvcnQgeyBCYWxhbmNlcywgQ29udHJhY3RzIH0gZnJvbSBcIi4vdHlwZXNcIjtcclxuaW1wb3J0IHtcclxuICBFcmMyMF9fZmFjdG9yeSxcclxuICBNZXRhUGF5bWVudF9fZmFjdG9yeSxcclxufSBmcm9tIFwiLi9jb250cmFjdHMvdHlwZXMvaW5kZXhcIjtcclxuXHJcblxyXG5leHBvcnQgY2xhc3MgQWNhZGVteUZvcmNlQ2xpZW50IHtcclxuICBwdWJsaWMgc3RhdGljIGZyb21VcmwodXJsOiBzdHJpbmcpOiBBY2FkZW15Rm9yY2VDbGllbnQge1xyXG4gICAgY29uc3QgcHJvdmlkZXIgPSBuZXcgZXRoZXJzLkpzb25ScGNQcm92aWRlcih1cmwpO1xyXG4gICAgcmV0dXJuIG5ldyB0aGlzKG51bGwsIHByb3ZpZGVyKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzdGF0aWMgZnJvbUNoYWluSWQoY2hhaW5JZDogQ2hhaW5JZCk6IEFjYWRlbXlGb3JjZUNsaWVudCB7XHJcbiAgICBjb25zdCBwcm92aWRlciA9IG5ldyBldGhlcnMuSnNvblJwY1Byb3ZpZGVyKFJQQ19VUkxTW2NoYWluSWRdKTtcclxuICAgIHJldHVybiBuZXcgdGhpcyhudWxsLCBwcm92aWRlcik7XHJcbiAgfVxyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgX3NpZ25lcj86IFNpZ25lciB8IG51bGwsXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9wcm92aWRlcj86IFByb3ZpZGVyIHwgbnVsbFxyXG4gICkge1xyXG4gICAgXHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0IHNpZ25lcigpOiBTaWduZXIge1xyXG4gICAgaWYgKHRoaXMuX3NpZ25lcikge1xyXG4gICAgICBpZiAodGhpcy5fc2lnbmVyLnByb3ZpZGVyKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3NpZ25lcjtcclxuICAgICAgfVxyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJBY2FkZW15Rm9yY2UgY2xpZW50IHNpZ25lciBoYXMgbm8gcHJvdmlkZXJcIik7XHJcbiAgICB9XHJcblxyXG4gICAgdGhyb3cgbmV3IEVycm9yKFwiQWNhZGVteUZvcmNlIGNsaWVudCBoYXMgbm8gc2lnbmVyXCIpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGdldCBwcm92aWRlcigpOiBQcm92aWRlciB7XHJcbiAgICBpZiAodGhpcy5fcHJvdmlkZXIpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuX3Byb3ZpZGVyO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMuX3NpZ25lcj8ucHJvdmlkZXIpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuX3NpZ25lci5wcm92aWRlcjtcclxuICAgIH1cclxuXHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJBY2FkZW15Rm9yY2UgY2xpZW50IGhhcyBubyBwcm92aWRlclwiKTtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBhc3luYyBnZXRDaGFpbklkKCk6IFByb21pc2U8Q2hhaW5JZD4ge1xyXG4gICAgY29uc3QgeyBjaGFpbklkIH0gPSBhd2FpdCB0aGlzLnByb3ZpZGVyLmdldE5ldHdvcmsoKTtcclxuICAgIHJldHVybiBOdW1iZXIoY2hhaW5JZCk7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgYXN5bmMgZ2V0Q29udHJhY3RzKCk6IFByb21pc2U8Q29udHJhY3RzPiB7XHJcbiAgICBjb25zdCBjaGFpbklkID0gYXdhaXQgdGhpcy5nZXRDaGFpbklkKCk7XHJcbiAgICBjb25zdCByZWdpc3RyeVVWID0gUmVnaXN0cnlfX2ZhY3RvcnkuY29ubmVjdChcclxuICAgICAgUkVHSVNUUllfQUREUkVTU0VTW2NoYWluSWRdLFxyXG4gICAgICB0aGlzLnByb3ZpZGVyXHJcbiAgICApO1xyXG4gICAgY29uc3QgX21ldGFDb3JlQWRkcmVzcyA9IGF3YWl0IHJlZ2lzdHJ5VVYuZ2V0TWV0YUNvcmUoKTtcclxuICAgIGNvbnN0IF9tZnNBZGRyZXNzID0gYXdhaXQgcmVnaXN0cnlVVi5nZXRNRlMoKTtcclxuICAgIGNvbnN0IF9zdGFibGVDb2luQWRkcmVzcyA9IGF3YWl0IHJlZ2lzdHJ5VVYuZ2V0U3RhYmxlQ29pbigpO1xyXG4gICAgY29uc3QgX2hNRlNBZGRyZXNzZXMgPSBuZXcgQXJyYXkoSE1GU19DT1VOVCk7XHJcbiAgICBmb3IobGV0IGkgPSAxOyBpPEhNRlNfQ09VTlQrMTtpKyspe1xyXG4gICAgICBfaE1GU0FkZHJlc3Nlc1tpLTFdID0gYXdhaXQgcmVnaXN0cnlVVi5nZXRITUZTKGkpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgX21ldGFDb3JlID0gTWV0YUNvcmVfX2ZhY3RvcnkuY29ubmVjdChcclxuICAgICAgX21ldGFDb3JlQWRkcmVzcyxcclxuICAgICAgdGhpcy5zaWduZXJcclxuICAgICk7XHJcbiAgICBjb25zdCBfbWV0YVBheW1lbnRBZGRyZXNzID0gYXdhaXQgX21ldGFDb3JlLmdldFBheW1lbnRDaGFubmVsQWRkcmVzcygpO1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgcmVnaXN0cnk6IFJlZ2lzdHJ5X19mYWN0b3J5LmNvbm5lY3QoUkVHSVNUUllfQUREUkVTU0VTW2NoYWluSWRdLCB0aGlzLnNpZ25lciksXHJcbiAgICAgIG1ldGFDb3JlOiBfbWV0YUNvcmUsXHJcbiAgICAgIG1ldGFQYXltZW50OiBNZXRhUGF5bWVudF9fZmFjdG9yeS5jb25uZWN0KFxyXG4gICAgICAgIF9tZXRhUGF5bWVudEFkZHJlc3MsXHJcbiAgICAgICAgdGhpcy5zaWduZXJcclxuICAgICAgKSxcclxuICAgICAgbWZzOiBFcmMyMF9fZmFjdG9yeS5jb25uZWN0KF9tZnNBZGRyZXNzLCB0aGlzLnNpZ25lciksXHJcbiAgICAgIHN0YWJsZWNvaW46IEVyYzIwX19mYWN0b3J5LmNvbm5lY3QoX3N0YWJsZUNvaW5BZGRyZXNzLCB0aGlzLnNpZ25lciksXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIGNsYWltKCBcclxuICAgY29udHJhY3Q6c3RyaW5nLFxyXG4gICBuYW1lOiBzdHJpbmdcclxuICApOiBQcm9taXNlPGV0aGVycy5Db250cmFjdFRyYW5zYWN0aW9uUmVjZWlwdCB8IG51bGw+IHsgXHJcbiAgICBjb25zdCBhZGRyZXNzID0gYXdhaXQgdGhpcy5zaWduZXIuZ2V0QWRkcmVzcygpO1xyXG4gICAgY29uc3QgYWNhZGVteUZvcmNlTkZUID0gQWNhZGVteUZvcmNlTkZUX19mYWN0b3J5LmNvbm5lY3QoXHJcbiAgICAgIGNvbnRyYWN0LCBcclxuICAgICAgdGhpcy5zaWduZXJcclxuICAgICAgKTtcclxuICAgIGxldCByZXM7XHJcbiAgICB0cnkge1xyXG4gICAgICByZXMgPSBhd2FpdCBmZXRjaChTRVJWRVJfVVJMLCB7XHJcbiAgICAgICAgbWV0aG9kOiBcIlBPU1RcIixcclxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGFkZHJlc3MsIGNvbnRyYWN0LCBuYW1lIH0pLFxyXG4gICAgICAgIGhlYWRlcnM6IHsgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIgfSxcclxuICAgICAgfSk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXMuanNvbigpO1xyXG4gICAgY29uc3QgY2xhaW0gPSBhd2FpdCBhY2FkZW15Rm9yY2VORlQuY2xhaW0oZGF0YS5nZXRBZGRyZXNzKCksIGRhdGEubmFtZSwgZGF0YS52LCBkYXRhLnIsIGRhdGEucyk7XHJcbiAgICByZXR1cm4gY2xhaW0ud2FpdCgpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIGdldEJhbGFuY2VzT25XYWxsZXQoYWNjb3VudD86IHN0cmluZyk6IFByb21pc2U8QmFsYW5jZXM+IHtcclxuICAgIGNvbnN0IHsgbWZzLCBzdGFibGVjb2lufSA9IGF3YWl0IHRoaXMuZ2V0Q29udHJhY3RzKCk7XHJcbiAgICBjb25zdCBfYWRkcmVzcyA9IGFjY291bnQgfHwgKGF3YWl0IHRoaXMuc2lnbmVyLmdldEFkZHJlc3MoKSk7XHJcblxyXG4gICAgY29uc3QgX2JhbGFuY2VNRlMgPSAgYXdhaXQgbWZzLmJhbGFuY2VPZihfYWRkcmVzcyk7XHJcbiAgICBjb25zdCBfYmFsYW5jZVN0YWJsZSA9ICBhd2FpdCBzdGFibGVjb2luLmJhbGFuY2VPZihfYWRkcmVzcyk7XHJcbiAgICBjb25zdCBfYmFsYW5jZU1hdGljID0gYXdhaXQgdGhpcy5wcm92aWRlci5nZXRCYWxhbmNlKF9hZGRyZXNzKTtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIG1mczogZXRoZXJzLmZvcm1hdFVuaXRzKF9iYWxhbmNlTUZTLCBERUNJTUFMUyksXHJcbiAgICAgIHN0YWJsZWNvaW46IGV0aGVycy5mb3JtYXRVbml0cyhfYmFsYW5jZVN0YWJsZSwgREVDSU1BTFMpLFxyXG4gICAgICBtYXRpYzogZXRoZXJzLmZvcm1hdFVuaXRzKF9iYWxhbmNlTWF0aWMsIERFQ0lNQUxTKSxcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYXN5bmMgZ2V0QmFsYW5jZXNPblBheW1lbnQoaWRVc2VyPzogbnVtYmVyKTogUHJvbWlzZTxCYWxhbmNlcz4ge1xyXG4gICAgY29uc3QgeyBtZnMsIHN0YWJsZWNvaW4sIG1ldGFQYXltZW50LCBtZXRhQ29yZSB9ID1cclxuICAgICAgYXdhaXQgdGhpcy5nZXRDb250cmFjdHMoKTtcclxuICAgIGNvbnN0IHVzZXJJZCA9XHJcbiAgICAgIGlkVXNlciB8fFxyXG4gICAgICBOdW1iZXIoXHJcbiAgICAgICAgYXdhaXQgbWV0YUNvcmUuZ2V0VXNlcklkKGF3YWl0IHRoaXMuc2lnbmVyLmdldEFkZHJlc3MoKSlcclxuICAgICAgKTtcclxuICAgIGNvbnN0IF9iYWxhbmNlTUZTID0gIGF3YWl0IG1ldGFQYXltZW50LmdldEJhbGFuY2UobWZzLmdldEFkZHJlc3MoKSwgdXNlcklkKTtcclxuICAgIGNvbnN0IF9iYWxhbmNlU3RhYmxlID0gIGF3YWl0IG1ldGFQYXltZW50LmdldEJhbGFuY2Uoc3RhYmxlY29pbi5nZXRBZGRyZXNzKCksIHVzZXJJZCk7XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgbWZzOiBldGhlcnMuZm9ybWF0VW5pdHMoX2JhbGFuY2VNRlMsIERFQ0lNQUxTKSxcclxuICAgICAgc3RhYmxlY29pbjogZXRoZXJzLmZvcm1hdFVuaXRzKF9iYWxhbmNlU3RhYmxlLCBERUNJTUFMUyksXHJcbiAgICAgIG1hdGljOiBcIjAuMFwiXHJcbiAgICB9O1xyXG4gIH1cclxufSJdfQ==